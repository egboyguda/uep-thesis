<% layout('layouts/sidebar')%> 
<link rel="stylesheet" href="https://cdn.datatables.net/1.10.25/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/1.7.1/css/buttons.dataTables.min.css">


<div class='row'>
    <div class="col-6 offset-3">
        <div class="mb-3">
            <label for="regions" class="form-label">Barangay</label>
                        <select name="destination" id="regions" class="form-select">
                            <option selected>Open this select menu</option>
                            <% for(barangay of barangays) {%>
                                <option value="<%= barangay.name%> "><%=barangay.name%>  </option>
                                <% } %>  
                        </select>
        </div>
        <input type="button" value="Find" class="btn btn-success" onClick='getData()'>
         <!-- Button trigger modal -->

  
  <!-- Modal -->
  <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content" id="content">
       
      </div>
    </div>
  </div>
</div>


<table id="example" class="display" style="width:100%">
    <thead>
	    <tr>
            <th class="text-center">Name</th>
            <th>Barangay</th>
            <th>Information</th>
            <th>Family member</th>
            <th>Remove</th>
         
	    </tr>
    </thead>
   
    </table>
 <a href="/family/"></a>
</div>    
    <script src="https://code.jquery.com/jquery-3.5.1.js"></script>
    <script src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/1.7.1/js/dataTables.buttons.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
    <script src="https://cdn.datatables.net/buttons/1.7.1/js/buttons.html5.min.js"></script>
<script>
    async function getData(){
        await $('#example').DataTable().clear().destroy();
        var barangay = document.getElementById('regions').value;
        axios.get(`/staff/household/${barangay}`)
        .then((res)=>{
            console.log(res.data)
            $("#example").DataTable({
                
    				data:res.data,
                    dom:'Bfrtip',
    				"columns":[
    					{"data":"name"},
    					{"data":"barangay"},
    					
                        {
                            "data":null,
                            "bSortable": false,
                            "mRender": function (o) { return `<button class='btn btn-success' onclick=getInfo("${o._id}");>` +'view'+'</button>'; }
                        },
                        {
                            "data":null,
                            "bSortable": false,
                            "mRender": function (o) { return `<a href="/family/${o._id}" class='btn btn-success'>view</a>`; }
                        }, {
                            "data":null,
                            "bSortable": false,
                            "mRender": function (o) { return `<button class='btn btn-danger' onclick=deleteD("${o._id}")>delete</button>`; }
                        }

            
            
    				],
                    
                    
                    buttons: [
            {
                extend: 'pdfHtml5', 
                exportOptions: {
                    columns: [ 0, 1 ]
                },
                download: 'open',

               customize: function ( doc ) {
doc.content[1].table.widths = [
'50%',
'50%',
'50%',
'50%',
'10%',
'10%',
'5%'
]
}
            }
        ]


    			 });
        })
    }

function getInfo(data){
  var myModal = new bootstrap.Modal(document.getElementById('exampleModal'))
  var modelBody= document.getElementById('content')
  axios.get(`/barangay/info/${data}`)
  .then((res)=>{
    console.log(res.data)
    data = res.data.person,
    imag= res.data.src

    modelBody.innerHTML =` <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">Information</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="modal-body">
          <div class=\"container\">
            <div class=\"row align-items-start\">
              <div class=\"col-5\">
                <div class=\"d-flex flex-column\">
                  <img src=\"${res.data.src}\" alt=\"\">
                  <a href="${res.data.src}" download class=\"btn btn-success">Download</a>
                </div>
              </div>
              <div class=\"col-6\">
                <div class=\"mb-3\">
                  <label for=\"name\" class=\"form-label\">Name</label>
                  <input type=\"text\" name=\"name\" id=\"name\" class=\"form-control\" value=\"${data.name.toUpperCase()}\" readonly=\'readonly\'>
                  <label for=\"barangay\" class=\"form-label\">Barangay</label>
                  <input type=\"text\" name=\"barangay\" id=\"barangay\" class=\"form-control\" value=\"${data.barangay}\" readonly=\'readonly\'>
                  <label for=\"beneficiary\" class=\"form-label\">Beneficiary</label>
                  <input type=\"text\" name=\"beneficiary\" id=\"beneficiary\" class=\"form-control\" value=\"${data.beneficiary}\" readonly=\'readonly\'>
                  <label for="fsector" class="form-label">Sector</label>
                                <select name="fsector" id="fsector" class="form-select">
                                    <option value="${data.sector}" selected>${data.sector}</option>
                                        <option name="nakakatanda">Nakakatanda</option>
                                        <option name="buntis">Buntis</option>
                                        <option name="nagpapasusong ina">Nag Papasusong ina</option>
                                        <option name="solo parent">Solo Parent</option>
                                        <option name="walang tirahan">Walang Tirahan</option>
                                </select>
             
                  <label for=\"contactNumber\" class=\"form-label\">Contact Number</label>
                  <input type=\"text\" name=\"contactNumber\" id="contactNumber\" class=\"form-control\" value=\"${data.contactNumber}\" >
                  <label for=\"occupation\" class=\"form-label\">Occupation</label>
                  <input type=\"text\" name=\"occupation\" id=\"occupation\" class=\"form-control\" value=\"${data.occupation}\">
                  <label for=\"income\" class=\"form-label\">Income</label>
                  <input type=\"text\" name=\"income\" id=\"income\" class=\"form-control\" value=\"${data.income}\" >
                  <label for=\"workplace\" class=\"form-label\">Workplace</label>
                  <input type=\"text\" name=\"workplace\" id=\"workplace\" class=\"form-control\" value=\"${data.workplace}\" >
                  <label for="fcivilStatus" class="form-label">Civil Status</label>
                                    <select name="civilStatus" id="fcivilStatus" class="form-select">
                                            <option value="${data.civilStatus}">${data.civilStatus}</option>
                                            <option value="single">Single</option>
                                            <option name="married">married</option>
                                            <option name="annulled">annulled</option>
                                            <option name="widow">widow</option>
                                    </select>
                  <label for="education" class="form-label">Highest Educational Attainment</label>
                <select name="education" id="education" class="form-select">
                    <option value="${data.education}">${data.education}</option>
                    <option value="Elementary level">Elementary Level</option>
                    <option name="highschool level">High School Level</option>
                    <option name="college level">College Level</option>
                    <option value="highschool graduate">Highschool Graduate</option>
                    <option value="college graduate">College Graduate</option>
                    <option value="Vocational graduate">Vocational Graduate</option>
                       
                </select>
                  <label for="health" class="form-label">Health Condition</label>
                    <select name="health" id="health" class="form-select">
                        <option selected>${data.health}</option>
                            <option value="sakit sa puso">Sakit sa puso</option>
                            <option name="altapresyun">Altapresyun</option>
                            <option name="sakit sa baga">Sakit sa Baga</option>
                            <option name="diyabetis">Diyabetis</option>
                            <option name="kanser">Kanser</option>
                           
                    </select>
              </div>  
              </div>
            </div>
        </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary"  onclick=updateData("${data._id}")>Save Changes</button>
   
        </div>`
    myModal.show()
  })

}
</script>
<script>
   myModal = new bootstrap.Modal(document.getElementById('exampleModal'))

  function updateData(val){
    //console.log(document.getElementById('fsector').value)
    var sector = document.getElementById('fsector').value
var health = document.getElementById('health').value
var education = document.getElementById('education').value
var civilStatus = document.getElementById('fcivilStatus').value
var workplace =document.getElementById("workplace").value
var income =document.getElementById("income").value
var occupation = document.getElementById("occupation").value
var contactNumber = document.getElementById("contactNumber").value

    axios.put(`/data/${val}`,{
      
      sector:sector,
      health:health,
      education:education,
      civilStatus:civilStatus,
      workplace:workplace,
      income:income,
      occupation:occupation,
      contactNumber:contactNumber

    
  }).then((res)=>{
    console.log('close')
    alert("success")
    
    
  })
  }
</script>
<script>
  function deleteD(val){
    axios.delete(`/del/${val}`)
    .then(()=>{
      location.reload()
    })
  }
</script>